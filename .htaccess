# Habilitar rewrite engine
RewriteEngine On

# Forzar HTTPS (excepto en localhost)
RewriteCond %{HTTPS} off
RewriteCond %{HTTP_HOST} !^localhost [NC]
RewriteCond %{HTTP_HOST} !^127\.0\.0\.1
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Headers CORS y Seguridad
<IfModule mod_headers.c>
    # Configuración CORS segura
    # Permitir localhost en desarrollo
    SetEnvIf Origin "http(s)?://(localhost|127\.0\.0\.1)(:[0-9]+)?$" AccessControlAllowOrigin=$0
    # Permitir dominio de producción
    SetEnvIf Origin "https://goldenrod-finch-839887\.hostingersite\.com$" AccessControlAllowOrigin=$0
    
    Header set Access-Control-Allow-Origin "%{AccessControlAllowOrigin}e" env=AccessControlAllowOrigin
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS, DELETE, PUT"
    Header set Access-Control-Allow-Headers "Content-Type, X-Requested-With, Authorization"
    Header set Access-Control-Allow-Credentials "true"
    
    # Headers de seguridad adicionales
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Eliminar información del servidor
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# Definir SITE_URL solo para el dominio de producción
SetEnvIf Host "^goldenrod-finch-839887\.hostingersite\.com$" SITE_URL=https://goldenrod-finch-839887.hostingersite.com

# Permitir que rutas /streaming-platform/ funcionen en hosts sin subcarpeta (solo producción)
RewriteCond %{HTTP_HOST} ^goldenrod-finch-839887\.hostingersite\.com$ [NC]
RewriteCond %{REQUEST_URI} ^/streaming-platform/ [NC]
RewriteRule ^streaming-platform/(.*)$ /$1 [L,R=302,NC]

# Redirigir requests a los endpoints de API
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# API Content endpoints
RewriteRule ^api/content/featured$ api/content/featured.php [L]
RewriteRule ^api/content/popular$ api/content/popular.php [L]
RewriteRule ^api/content/recent$ api/content/recent.php [L]
RewriteRule ^api/content/([0-9]+)$ api/content/index.php?id=$1 [L]

# API Movies endpoints
RewriteRule ^api/movies/?$ api/movies/index.php [L,QSA]
RewriteRule ^api/movies/([0-9]+)$ api/movies/index.php?id=$1 [L]

# Redirigir favicon.ico a icono SVG si no existe
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^favicon\.ico$ assets/icons/icon.svg [L]

# Permitir acceso a archivos estáticos
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

