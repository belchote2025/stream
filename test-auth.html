<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Autenticación</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            padding: 2rem;
            max-width: 600px;
            margin: 0 auto;
        }
        .form-container {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .user-info {
            display: none;
            margin-top: 2rem;
            padding: 1rem;
            background: #e9ecef;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Prueba de Autenticación</h1>
        
        <!-- Formulario de Registro -->
        <div class="form-container mb-4" id="registerForm">
            <h3>Registro</h3>
            <form id="registerFormElement">
                <div class="mb-3">
                    <label for="regUsername" class="form-label">Nombre de usuario</label>
                    <input type="text" class="form-control" id="regUsername" required>
                </div>
                <div class="mb-3">
                    <label for="regEmail" class="form-label">Correo electrónico</label>
                    <input type="email" class="form-control" id="regEmail" required>
                </div>
                <div class="mb-3">
                    <label for="regPassword" class="form-label">Contraseña</label>
                    <input type="password" class="form-control" id="regPassword" required>
                </div>
                <div class="mb-3">
                    <label for="regFullName" class="form-label">Nombre completo (opcional)</label>
                    <input type="text" class="form-control" id="regFullName">
                </div>
                <button type="submit" class="btn btn-primary">Registrarse</button>
            </form>
        </div>
        
        <!-- Formulario de Inicio de Sesión -->
        <div class="form-container mb-4" id="loginForm">
            <h3>Iniciar Sesión</h3>
            <form id="loginFormElement">
                <div class="mb-3">
                    <label for="loginEmail" class="form-label">Correo electrónico</label>
                    <input type="email" class="form-control" id="loginEmail" required>
                </div>
                <div class="mb-3">
                    <label for="loginPassword" class="form-label">Contraseña</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-success">Iniciar Sesión</button>
            </form>
        </div>
        
        <!-- Información del Usuario -->
        <div class="user-info" id="userInfo">
            <h3>Información del Usuario</h3>
            <p><strong>ID:</strong> <span id="userId"></span></p>
            <p><strong>Usuario:</strong> <span id="userUsername"></span></p>
            <p><strong>Email:</strong> <span id="userEmail"></span></p>
            <p><strong>Rol:</strong> <span id="userRole"></span></p>
            <button id="logoutBtn" class="btn btn-danger">Cerrar Sesión</button>
        </div>
        
        <!-- Prueba de Ruta Protegida -->
        <div class="form-container mt-4">
            <h3>Prueba de Ruta Protegida</h3>
            <button id="testAuthBtn" class="btn btn-info">Probar Autenticación</button>
            <div id="testResult" class="mt-3"></div>
        </div>
    </div>

    <script>
        // URL base de la API
        const API_BASE_URL = 'http://localhost/streaming-platform/api/auth';
        
        // Elementos del DOM
        const registerForm = document.getElementById('registerFormElement');
        const loginForm = document.getElementById('loginFormElement');
        const logoutBtn = document.getElementById('logoutBtn');
        const testAuthBtn = document.getElementById('testAuthBtn');
        const userInfo = document.getElementById('userInfo');
        
        // Manejar el registro de usuario
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userData = {
                username: document.getElementById('regUsername').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                full_name: document.getElementById('regFullName').value || undefined
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Error en el registro');
                }
                
                // Mostrar mensaje de éxito
                await Swal.fire({
                    icon: 'success',
                    title: '¡Registro exitoso!',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Actualizar la interfaz de usuario
                updateUserInfo(data.user);
                
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message
                });
            }
        });
        
        // Manejar el inicio de sesión
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const credentials = {
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    credentials: 'include', // Importante para manejar cookies
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(credentials)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Error en el inicio de sesión');
                }
                
                // Mostrar mensaje de éxito
                await Swal.fire({
                    icon: 'success',
                    title: '¡Inicio de sesión exitoso!',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Actualizar la interfaz de usuario
                updateUserInfo(data.user);
                
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message
                });
            }
        });
        
        // Manejar el cierre de sesión
        logoutBtn.addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/logout`, {
                    method: 'POST',
                    credentials: 'include' // Importante para manejar cookies
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Error al cerrar sesión');
                }
                
                // Mostrar mensaje de éxito
                await Swal.fire({
                    icon: 'success',
                    title: 'Sesión cerrada',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Actualizar la interfaz de usuario
                resetUI();
                
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message
                });
            }
        });
        
        // Probar ruta protegida
        testAuthBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/streaming-platform/api/movies', {
                    method: 'GET',
                    credentials: 'include' // Importante para enviar cookies
                });
                
                const data = await response.json();
                const testResult = document.getElementById('testResult');
                
                if (response.ok) {
                    testResult.innerHTML = `
                        <div class="alert alert-success">
                            <strong>¡Éxito!</strong> Tienes acceso a la ruta protegida.
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    testResult.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error ${response.status}:</strong> ${data.error || 'No autorizado'}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('testResult').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        });
        
        // Actualizar la interfaz con la información del usuario
        function updateUserInfo(user) {
            document.getElementById('userId').textContent = user.id;
            document.getElementById('userUsername').textContent = user.username;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userRole').textContent = user.role || 'free_user';
            
            // Mostrar información del usuario y ocultar formularios
            userInfo.style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'none';
        }
        
        // Restablecer la interfaz de usuario
        function resetUI() {
            // Limpiar formularios
            document.getElementById('registerFormElement').reset();
            document.getElementById('loginFormElement').reset();
            
            // Mostrar formularios y ocultar información del usuario
            userInfo.style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('loginForm').style.display = 'block';
            
            // Limpiar resultados de prueba
            document.getElementById('testResult').innerHTML = '';
        }
        
        // Verificar el estado de autenticación al cargar la página
        async function checkAuthStatus() {
            try {
                const response = await fetch('/streaming-platform/api/movies', {
                    method: 'GET',
                    credentials: 'include' // Importante para enviar cookies
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Si la solicitud fue exitosa, el usuario está autenticado
                    // Hacer una solicitud para obtener la información del usuario actual
                    const userResponse = await fetch('/streaming-platform/api/auth/me', {
                        credentials: 'include'
                    });
                    
                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        updateUserInfo(userData);
                    }
                }
            } catch (error) {
                console.log('Usuario no autenticado');
            }
        }
        
        // Verificar el estado de autenticación al cargar la página
        document.addEventListener('DOMContentLoaded', checkAuthStatus);
    </script>
</body>
</html>
